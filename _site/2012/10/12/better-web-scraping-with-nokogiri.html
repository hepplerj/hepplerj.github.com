<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta content="The online writing of Jason Heppler" name="description"/>
<title>Better Web Scraping with Nokogiri</title> <meta name="author" content="Jason Heppler" />
<link rel="stylesheet" href="/css/syntax.css" type="text/css" />
<link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
<link rel="stylesheet" href="/css/tweet.css" type="text/css" />
<link href="/webfonts/ss-social.css" rel="stylesheet" />
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="http://jasonheppler.org/js/styleTweets.js"></script>

<link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

<script src="http://d3js.org/d3.v3.min.js"></script>

<style>

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.bar {
  fill: steelblue;
}

.x.axis path {
  display: none;
}

svg {
  font: 13px sans-serif;
}

</style>

   <script type="text/javascript">

     var _gaq = _gaq || [];
     _gaq.push(['_setAccount', 'UA-12786552-1']);
     _gaq.push(['_trackPageview']);

     (function() {
       var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
       ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
       var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
     })();

   </script>

</head>
<body>

<div class="header">
	<div class="header_container">

		<section class="name"><a href="/">Jason Heppler</a></section>
		<ul class="menu">
			<li><a href="/about.html">Colophon</a></li>
			<li><a href="/research.html">Research</a></li>
			<li><a href="/teaching.html">Teaching</a></li>
			<li><a href="/hacks.html">Digital &amp; Public History</a></li>
			<li><a href="http://jasonheppler.org/jah-vita.pdf">Vita</a></li>
		</ul>
	</div>
</div>

<section class="container content">

<aside><p class="when">October 12, 2012</p></aside>
<h1>Better Web Scraping with Nokogiri</h1>

<p>When I wrote <a href="http://hepplerj.github.com/rubyist-historian/">The Rubyist Historian</a> a year ago, I was still getting familiar with the ins and outs of Ruby (and, truth be told, I am still doing so &#8211; it will <a href="http://norvig.com/21-days.html">take a long time before</a> I, if ever, call myself a programmer). Looking back on the word count program I wrote at the end, I&#8217;ve realized a big error: I used regular expressions to parse a webpage.</p>

<p>There&#8217;s a much more effective way to do it: with the Ruby library <a href="http://nokogiri.org/">Nokogiri</a>. Nokogiri is built for HTML, XML, and SAX parsing and includes features that allows you to search for specific CSS3 or XPath selectors. Install the package through Ruby gems (<code>sudo gem install nokogiri</code>) and you&#8217;ll be good to go.</p>

<p>Let&#8217;s say I wanted to do some text analysis on the books written by William F. Cody. On the <a href="http://www.codyarchive.org">Cody Archive</a>, we currently have three of these books digitized, edited, and ready to go. They&#8217;re encoded with TEI standards and include metadata and information you might want for more sophisticated types of analysis. But to work with them, let&#8217;s say I&#8217;d like to have three clean copies of the text on my local machine without any markup included &#8211; just plain, clean, flat text files. Using Nokogiri, the process is pretty straightforward.</p>

<p>Fire up your text editor of choice, and write:</p>

<div class="highlight"><pre><code class="ruby"><span class="c1">#!/usr/bin/env ruby</span>

<span class="c1"># Name: grabtext.rb</span>
<span class="c1"># By: Jason Heppler</span>
<span class="c1"># Last Modified Fri Oct 12 14:43:58 2012</span>
<span class="c1">#</span>
<span class="c1"># This script uses Nokogiri to grab the text only between the &#39;text&#39; tag</span>
<span class="c1"># in XML files. Modify as you need. </span>
<span class="c1"># Usage: ./grabtext.rb path/to/file &gt; output.txt</span>

<span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;nokogiri&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;open-uri&#39;</span>

<span class="n">doc</span> <span class="o">=</span> <span class="ss">Nokogiri</span><span class="p">:</span><span class="ss">:HTML</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">))</span>

<span class="n">doc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="n">link</span><span class="o">.</span><span class="n">content</span>
<span class="k">end</span>
</code></pre></div>

<p>Now I can run it from the command line (don&#8217;t forget to <code>chmod</code> the script):</p>

<div class="highlight"><pre><code class="text">$ ./grabtext.rb http://codyarchive.org/texts/wfc.bks00007.xml &gt; autobiography.txt
</code></pre></div>

<p>For your own purposes, you may have to make some edits to the code. In my case, I&#8217;m parsing an XML file that includes the tag <code>text</code> and, therefore, I tell Nokogiri to look for that with <code>doc.search('text')</code>. <a href="http://codyarchive.org/texts/wfc.bks00007.xml">The XML file</a> looks something like this:</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;TEI</span> <span class="na">xml:id=</span><span class="s">&quot;wfc.bks00007&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.tei-c.org/ns/1.0&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;teiHeader&gt;</span>
...
<span class="nt">&lt;/teiHeader&gt;</span>
<span class="nt">&lt;text&gt;</span> <span class="c">&lt;!-- the script grabs the text from here... --&gt;</span>
<span class="nt">&lt;front&gt;</span>
<span class="nt">&lt;pb</span> <span class="na">facs=</span><span class="s">&quot;wfc.bks00007.006&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;div1&gt;</span>
<span class="nt">&lt;figure</span> <span class="na">n=</span><span class="s">&quot;illustration&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;p&gt;</span>Yours Sincerely, W. F. Cody<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/figure&gt;</span>
<span class="nt">&lt;/div1&gt;</span>
<span class="nt">&lt;pb</span> <span class="na">facs=</span><span class="s">&quot;wfc.bks00007.007&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;titlePage&gt;</span>
<span class="nt">&lt;docTitle&gt;</span>
<span class="nt">&lt;titlePart&gt;</span>THE LIFE OF
<span class="nt">&lt;lb/&gt;</span>
HON. WILLIAM F. CODY
<span class="nt">&lt;lb/&gt;</span>
KNOWN AS
<span class="nt">&lt;lb/&gt;</span>
BUFFALO BILL

...

<span class="nt">&lt;p&gt;</span>After a successful tour of six weeks on the Pacific Slope, thus ending the season of 1878-79, I am at my home at North Platte, Nebraska, for the summer; and thus ends the account of my career as far as it has gone.<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;ab&gt;</span>THE END.<span class="nt">&lt;/ab&gt;</span>
<span class="nt">&lt;/div1&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/text&gt;</span> <span class="c">&lt;!-- ...down to here --&gt;</span>
<span class="nt">&lt;/TEI&gt;</span>
</code></pre></div>

<p>I don&#8217;t want any of the TEI header information, so using Nokogiri I can grab everything between the <code>text</code> tag. This leaves me with the raw text of the XML file without any of the markup or header information.</p>

<p>I&#8217;m becoming more and more convinced that at least half of the work I do in digital history is cleaning up and preparing data so it can be usable. I find this little script to be handy for doing a quick grab of a site&#8217;s contents, and because Nokogiri is incredibly powerful it can chug through web pages that aren&#8217;t well-formed or valid markup. It&#8217;s faster than <code>wget</code> and, unlike <code>wget</code>, leaves me with plain text that I can start to work with right away.</p>

<p><strong>UPDATE</strong>: The program can be simplified slightly by changing the loop:</p>

<div class="highlight"><pre><code class="ruby"><span class="c1">#!/usr/bin/env ruby</span>

<span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;nokogiri&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;open-uri&#39;</span>

<span class="n">doc</span> <span class="o">=</span> <span class="ss">Nokogiri</span><span class="p">:</span><span class="ss">:HTML</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">))</span> <span class="c1">#input</span>
<span class="n">doc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">link</span><span class="o">.</span><span class="n">content</span> <span class="p">}</span> <span class="c1">#plain text output</span>
</code></pre></div>



<section class="post_meta">
  <div class="block">
    <a href="http://twitter.com/jaheppler">
      <span class="ss-twitter ss-social-circle">
        <div>Follow me on Twitter.</div>
      </span>
    </a>
  </div>
  
  <div class="block">
  	<a href="http://acomp.stanford.edu/faculty/atsp">
  		<span class="ss-like ss-social-circle">
  			<div>I am the Academic Technology Specialist in the History Department at Stanford University.</div>
  		</span>
  	</a>
  </div>

  <div class="block">
  	<a href="http://github.com/hepplerj">
  		<span class="ss-github ss-social-circle">
  			<div>Follow me on Github.</div>
  		</span>
  	</a>
  </div>
</section>


</section>

<footer>
	Tech, history, code, coffee • Written by <a href="http://jasonheppler.org/about.html">Jason Heppler</a> • Powered by <a href="http://github.com/mojombo/jekyll">Jekyll</a> <br/> Licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC-BY</a> • <a href="http://www.jasonheppler.org/feed.xml">Subscribe to RSS</a>

<br>

Remember <a href="http://lessig.tumblr.com/post/40347463044/prosecutor-as-bully">Aaron Swartz</a>

</footer>

</body>
</html>
